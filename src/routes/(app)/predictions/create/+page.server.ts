import { db } from '$lib/server/db';
import * as schema from '$lib/server/db/schema';
import { createManualPredictionMarket, createAssetPredictionMarket } from '$lib/server/predictions/predictions';
import { fail, redirect } from '@sveltejs/kit';
import { eq } from 'drizzle-orm';
import type { Actions, PageServerLoad } from './$types';

export const load: PageServerLoad = async () => {
	const currencies = await db.select().from(schema.currency).where(eq(schema.currency.isRealWorld, false));
	const assets = await db.select().from(schema.asset);
	return {
		currencies,
		assets
	};
};

export const actions: Actions = {
	default: async ({ request, locals }) => {
		if (!locals.user) {
			throw redirect(302, '/login');
		}

		const formData = await request.formData();
		const type = formData.get('type') as string;
		const endDateStr = formData.get('endDate') as string;
		const currencyId = formData.get('currencyId') as string;

		if (!endDateStr || !currencyId) {
			return fail(400, { missing: true });
		}

		const endDate = new Date(endDateStr);

		// Ensure currency is allowed (is_real_world = false)
		const currency = await db.query.currency.findFirst({
			where: eq(schema.currency.id, currencyId)
		});

		if (!currency || currency.isRealWorld) {
			return fail(400, { invalidCurrency: true });
		}

		try {
			let marketId;
			if (type === 'asset') {
				const assetId = formData.get('assetId') as string;
				const targetPriceStr = formData.get('targetPrice') as string;
				const direction = formData.get('direction') as 'above' | 'below';
				
				if (!assetId || !targetPriceStr || !direction) {
					return fail(400, { missing: true });
				}
				
				marketId = await createAssetPredictionMarket(
					null, // Autogenerated title
					assetId,
					parseFloat(targetPriceStr),
					direction,
					endDate,
					14000,
					currencyId
				);
			} else {
				const title = formData.get('title') as string;
				const text = formData.get('text') as string;
				if (!title || !text) {
					return fail(400, { missing: true });
				}
				marketId = await createManualPredictionMarket(
					title,
					text,
					endDate,
					locals.user.id,
					14000,
					currencyId
				);
			}

			throw redirect(303, `/predictions/${marketId}`);
		} catch (e) {
			console.error(e);
            if ((e as any).status === 303) throw e;
			return fail(500, { error: 'Failed to create market' });
		}
	}
};
